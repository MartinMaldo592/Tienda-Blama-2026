(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,27989,20916,65658,98330,16282,31289,75611,33923,62794,12666,28276,63508,e=>{"use strict";var t=e.i(53210);async function a(e){let a=String(e.role||"worker"),r=String(e.currentUserId||""),{data:s}=await t.supabase.from("pedidos").select("id, total, status, asignado_a, created_at"),i=(s||[]).filter(e=>"Entregado"===e.status),o=i.reduce((e,t)=>e+(Number(t.total)||0),0),n=new Date,d=n.getFullYear(),c=String(n.getMonth()+1).padStart(2,"0"),l=String(n.getDate()).padStart(2,"0"),u=`${d}-${c}-${l}`,m=i.filter(e=>"string"==typeof e.created_at&&e.created_at.startsWith(u)).reduce((e,t)=>e+(Number(t.total)||0),0),p=(s||[]).filter(e=>"Pendiente"===e.status).length,f=(s||[]).filter(e=>["Confirmado","Preparando","Enviado"].includes(e.status)).length,h=i.length,b=(s||[]).filter(e=>e.asignado_a===r&&!["Fallido","Devuelto","Entregado"].includes(e.status)).length,w=0;if("admin"===a){let{count:e}=await t.supabase.from("clientes").select("*",{count:"exact",head:!0});w=e||0}let g=0;if("admin"===a){let{count:e}=await t.supabase.from("productos").select("*",{count:"exact",head:!0}).lt("stock",5);g=e||0}return{totalVentasReales:o,ventasHoy:m,pedidosPendientes:p,pedidosEnProceso:f,pedidosEntregados:h,pedidosAsignados:b,totalClientes:w,productosLowStock:g}}async function r(e){let a=e.from?`${e.from}T00:00:00.000Z`:void 0,r=e.to?`${e.to}T23:59:59.999Z`:void 0,s=t.supabase.from("pedidos").select("id, total, status, created_at, clientes (nombre, telefono, dni)").eq("status","Entregado").order("created_at",{ascending:!1});a&&(s=s.gte("created_at",a)),r&&(s=s.lte("created_at",r));let{data:i,error:o}=await s;if(o)throw o;return i||[]}async function s(e){let a=Number(e.threshold),{data:r,error:s}=await t.supabase.from("productos").select("id, nombre, precio, stock, imagen_url").lt("stock",a).order("stock",{ascending:!0});if(s)throw s;return r||[]}async function i(){let{data:e,error:a}=await t.supabase.from("pedidos").select("id, total, status, created_at, clientes (nombre, telefono, dni)").eq("status","Pendiente").order("created_at",{ascending:!1});if(a)throw a;return e||[]}let o=["Confirmado","Preparando","Enviado"];async function n(e){let a=e.from?`${e.from}T00:00:00.000Z`:void 0,r=e.to?`${e.to}T23:59:59.999Z`:void 0,s=t.supabase.from("pedidos").select("id, total, status, created_at, asignado_a, clientes (nombre, telefono, dni)").in("status",o).order("created_at",{ascending:!1});"all"!==e.status&&(s=s.eq("status",e.status)),a&&(s=s.gte("created_at",a)),r&&(s=s.lte("created_at",r));let{data:i,error:n}=await s;if(n)throw n;return i||[]}async function d(){let{data:e,error:a}=await t.supabase.from("profiles").select("id, email, nombre, role").eq("role","worker");if(a)throw a;return e||[]}async function c(e){let a=String(e.role||"worker"),r=String(e.currentUserId||""),s=t.supabase.from("pedidos").select(`
        *,
        clientes (nombre, telefono, dni)
      `).order("created_at",{ascending:!1});"worker"===a&&(s=s.eq("asignado_a",r));let{data:i,error:o}=await s;if(o){if(String(o.message||"").includes("asignado_a")){let{data:e}=await t.supabase.from("pedidos").select("*, clientes (nombre, telefono, dni)").order("created_at",{ascending:!1});return e||[]}throw o}return await Promise.all((i||[]).map(async e=>{if(e.asignado_a){let{data:a}=await t.supabase.from("profiles").select("id, email, nombre").eq("id",e.asignado_a).single();return{...e,asignado_perfil:a||null}}return{...e,asignado_perfil:null}}))}async function l(e){let a=e.workerId?String(e.workerId):null,{error:r}=await t.supabase.from("pedidos").update({asignado_a:a,fecha_asignacion:a?new Date().toISOString():null}).eq("id",e.pedidoId);if(r)throw r}async function u(e){let{data:a,error:r}=await t.supabase.from("pedidos").select(`
        *,
        clientes (*)
      `).eq("id",e).single();if(r)throw r;let s=null;if(a?.asignado_a){let{data:e}=await t.supabase.from("profiles").select("id, email, nombre").eq("id",a.asignado_a).single();s=e}let i={...a,asignado_perfil:s},{data:o,error:n}=await t.supabase.from("pedido_items").select(`
        *,
        productos (nombre, precio, imagen_url)
      `).eq("pedido_id",e);if(n)throw n;return{pedido:i,items:o||[]}}async function m(e){let a=Number(e.pedidoId),r=String(e.nextStatus||"");if("Confirmado"===r&&!e.stockDescontado){let{data:e,error:r}=await t.supabase.from("pedido_items").select("producto_id, producto_variante_id, cantidad").eq("pedido_id",a);if(r)throw r;for(let a of(e||[]).filter(e=>e.producto_id)){let e=Number(a.producto_id),r=null!=a.producto_variante_id?Number(a.producto_variante_id):null,s=Number(a.cantidad||0);if(e&&!(s<=0))if(r){let{data:e,error:a}=await t.supabase.from("producto_variantes").select("stock").eq("id",r).single();if(a)throw a;let i=Math.max(0,Number(e?.stock??0)-s),{error:o}=await t.supabase.from("producto_variantes").update({stock:i}).eq("id",r);if(o)throw o}else{let{data:a,error:r}=await t.supabase.from("productos").select("stock").eq("id",e).single();if(r)throw r;let i=Math.max(0,Number(a?.stock??0)-s),{error:o}=await t.supabase.from("productos").update({stock:i}).eq("id",e);if(o)throw o}}let{error:s}=await t.supabase.from("pedidos").update({stock_descontado:!0}).eq("id",a);if(s)throw s}let{error:s}=await t.supabase.from("pedidos").update({status:r}).eq("id",a);if(s)throw s}async function p(){let{data:e,error:a}=await t.supabase.from("productos").select("*").order("id",{ascending:!0});if(a)throw a;return e||[]}async function f(e){let{data:a,error:r}=await t.supabase.from("productos").select("*").eq("id",e).single();if(r)throw r;return a}async function h(){let{data:e,error:a}=await t.supabase.from("categorias").select("*");if(a)throw a;return e||[]}async function b(e){let a=String(e.nombre||"").trim(),r=a.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,""),{data:s,error:i}=await t.supabase.from("categorias").insert({nombre:a,slug:r}).select().single();if(i)throw i;return s}async function w(e){let[a,r]=await Promise.all([t.supabase.from("producto_especificaciones").select("*").eq("producto_id",e).order("orden",{ascending:!0}).order("id",{ascending:!0}),t.supabase.from("producto_variantes").select("*").eq("producto_id",e).order("id",{ascending:!0})]);return{specs:a.data||[],variants:r.data||[]}}async function g(e){let a=Array.isArray(e.files)?e.files:[],r=[];for(let e of a){let a=e.name.split(".").pop()||"jpg",s=`${Date.now()}-${Math.random().toString(16).slice(2)}.${a}`,i=`imagenes/${s}`,{error:o}=await t.supabase.storage.from("productos").upload(i,e);if(o)throw o;let{data:n}=t.supabase.storage.from("productos").getPublicUrl(i);n?.publicUrl&&r.push(n.publicUrl)}return r}async function y(e){let a=Array.isArray(e.files)?e.files:[],r=[];for(let e of a){let a=e.name.split(".").pop()||"mp4",s=`${Date.now()}-${Math.random().toString(16).slice(2)}.${a}`,i=`videos/${s}`,{error:o}=await t.supabase.storage.from("productos").upload(i,e,{upsert:!1,contentType:e.type||"video/mp4"});if(o)throw o;let{data:n}=t.supabase.storage.from("productos").getPublicUrl(i);n?.publicUrl&&r.push(n.publicUrl)}return r}async function x(e){let t=await fetch("/api/admin/productos",{method:e.method,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify(e.body)}),a=null;try{a=await t.json()}catch(e){a=null}if(!t.ok||!a?.ok)throw Error(String(a?.error||"No se pudo guardar el producto"));return a}async function _(e){let t=await fetch("/api/admin/productos",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify({id:e.id})}),a=null;try{a=await t.json()}catch(e){a=null}if(!t.ok||!a?.ok)throw Error(String(a?.error||"No se pudo eliminar"));return a}async function v(){let{data:e,error:a}=await t.supabase.from("profiles").select("id, email, nombre, role, created_at").order("created_at",{ascending:!1});if(a)throw a;return e||[]}async function N(e){let t=await fetch("/api/admin/create-worker",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.accessToken}`},body:JSON.stringify({email:e.email,nombre:e.nombre,password:e.password})}),a=await t.json();if(!t.ok)throw Error(String(a?.error||"Error"));return a}async function j(){let{data:e,error:a}=await t.supabase.from("cupones").select("*").order("created_at",{ascending:!1});if(a)throw a;return e||[]}async function S(e){let{error:a}=await t.supabase.from("cupones").insert(e);if(a)throw a}async function A(e,a){let{error:r}=await t.supabase.from("cupones").update(a).eq("id",e);if(r)throw r}async function k(e){let{error:a}=await t.supabase.from("cupones").delete().eq("id",e);if(a)throw a}async function q(){let{data:e,error:a}=await t.supabase.from("home_banners").select("*").order("orden",{ascending:!0}).order("id",{ascending:!0});if(a)throw a;return e||[]}async function P(e){if(null!=e.id){let{error:a}=await t.supabase.from("home_banners").update(e.payload).eq("id",e.id);if(a)throw a;return}let{error:a}=await t.supabase.from("home_banners").insert(e.payload);if(a)throw a}async function C(e){let{error:a}=await t.supabase.from("home_banners").delete().eq("id",e);if(a)throw a}async function $(){let e=await t.supabase.auth.getSession();return e?.data?.session?.access_token||""}async function E(){let e=await $();if(!e)throw Error("No autorizado");let t=await fetch("/api/admin/announcement-bar",{method:"GET",headers:{Authorization:`Bearer ${e}`}}),a=null;try{a=await t.json()}catch(e){a=null}if(!t.ok||!a?.ok)throw Error(String(a?.error||"No se pudo obtener la configuración"));let r=a?.data||{};return{enabled:!!r.enabled,interval_ms:Number(r.interval_ms)||3500,messages:Array.isArray(r.messages)?r.messages:[]}}async function T(e){let t=await $();if(!t)throw Error("No autorizado");let a=await fetch("/api/admin/announcement-bar",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)}),r=null;try{r=await a.json()}catch(e){r=null}if(!a.ok||!r?.ok)throw Error(String(r?.error||"No se pudo guardar"));return r}async function I(){let{data:e,error:a}=await t.supabase.from("pedidos").select("id, status, created_at, clientes (nombre, telefono)").order("created_at",{ascending:!1}).limit(200);if(a)throw a;return e||[]}async function B(){let{data:e,error:a}=await t.supabase.from("incidencias").select("*, pedidos (id, status, created_at, clientes (nombre, telefono))").order("created_at",{ascending:!1});if(a)throw a;return e||[]}async function D(e){let a=String(e.pedidoId||"").trim(),r=Array.isArray(e.files)?e.files:[],s=[];for(let e of r){let r=e.name.split(".").pop()||"jpg",i=`${Date.now()}-${Math.random().toString(16).slice(2)}.${r}`,o=a?`incidencias/${a}`:"incidencias",n=`${o}/${i}`,{error:d}=await t.supabase.storage.from("productos").upload(n,e);if(d)throw d;let{data:c}=t.supabase.storage.from("productos").getPublicUrl(n);c?.publicUrl&&s.push(c.publicUrl)}return s}async function U(e){async function a(a){let r={...e};return a||delete r.fotos,t.supabase.from("incidencias").insert(r)}let r=(await a(!0)).error;if(r&&"string"==typeof r.message&&r.message.toLowerCase().includes("fotos")&&(r=(await a(!1)).error),r)throw Error(r.message)}async function V(e){let{error:a}=await t.supabase.from("incidencias").delete().eq("id",e);if(a)throw a}async function O(){let{data:e,error:a}=await t.supabase.from("product_questions").select("id, product_id, question, asker_name, asker_phone, published, created_at, productos(nombre), product_answers(id, answer, answered_by, created_at, published)").order("created_at",{ascending:!1}).limit(200);if(a)throw a;return e||[]}async function z(e){let{error:a}=await t.supabase.from("product_questions").update({published:e.published}).eq("id",e.id);if(a)throw a}async function R(e){let a=String(e.answer||"").trim(),{data:r}=await t.supabase.auth.getSession(),s=r?.session?.user?.id||null,i=null;if(s){let{data:e}=await t.supabase.from("profiles").select("email, nombre").eq("id",s).maybeSingle();i=String(e?.nombre||e?.email||"Admin")}let{data:o}=await t.supabase.from("product_questions").select("id, product_answers(id)").eq("id",e.questionId).maybeSingle(),n=o&&Array.isArray(o.product_answers)&&o.product_answers.length>0?Number(o.product_answers[0]?.id):null;if(n){let{error:e}=await t.supabase.from("product_answers").update({answer:a,answered_by:i,published:!0}).eq("id",n);if(e)throw e}else{let{error:r}=await t.supabase.from("product_answers").insert({question_id:e.questionId,answer:a,answered_by:i,published:!0});if(r)throw r}let{error:d}=await t.supabase.from("product_questions").update({published:!0}).eq("id",e.questionId);if(d)throw d}async function M(){let{data:e,error:a}=await t.supabase.from("product_reviews").select("id, product_id, rating, title, body, customer_name, customer_city, verified, approved, created_at, productos(nombre)").order("created_at",{ascending:!1}).limit(200);if(a)throw a;return e||[]}async function W(e){let{error:a}=await t.supabase.from("product_reviews").update({approved:e.approved}).eq("id",e.id);if(a)throw a}async function F(e){let{error:a}=await t.supabase.from("product_reviews").delete().eq("id",e);if(a)throw a}async function J(){let{data:e,error:a}=await t.supabase.from("clientes").select("*").order("id",{ascending:!1});if(a)throw a;return e||[]}e.s(["fetchAdminDashboardStats",()=>a,"fetchAdminPedidosEnProceso",()=>n,"fetchAdminPedidosPendientes",()=>i,"fetchAdminStockBajo",()=>s,"fetchAdminVentasEntregadas",()=>r],20916),e.s(["assignPedidoToWorker",()=>l,"fetchAdminWorkers",()=>d,"fetchPedidoDetail",()=>u,"fetchPedidosForRole",()=>c,"updatePedidoStatusWithStock",()=>m],65658),e.s(["createAdminCategoria",()=>b,"deleteAdminProductoViaApi",()=>_,"fetchAdminCategorias",()=>h,"fetchAdminProductoById",()=>f,"fetchAdminProductos",()=>p,"fetchProductoSpecsAndVariants",()=>w,"saveAdminProductoViaApi",()=>x,"uploadProductImages",()=>g,"uploadProductVideos",()=>y],98330),e.s(["createWorkerViaApi",()=>N,"fetchAdminProfiles",()=>v],16282),e.s(["createAdminCupon",()=>S,"deleteAdminCupon",()=>k,"fetchAdminCupones",()=>j,"updateAdminCupon",()=>A],31289),e.s(["deleteHomeBanner",()=>C,"fetchHomeBanners",()=>q,"saveHomeBanner",()=>P],75611),e.s(["fetchAnnouncementBarConfigViaApi",()=>E,"saveAnnouncementBarConfigViaApi",()=>T],33923),e.s(["createIncidencia",()=>U,"deleteIncidencia",()=>V,"fetchIncidencias",()=>B,"fetchPedidosForIncidencias",()=>I,"uploadIncidenciaImages",()=>D],62794),e.s(["fetchAdminQuestions",()=>O,"saveQuestionAnswer",()=>R,"setQuestionPublished",()=>z],12666),e.s(["deleteReview",()=>F,"fetchAdminReviews",()=>M,"setReviewApproved",()=>W],28276),e.s(["fetchAdminClientes",()=>J],63508),e.s([],27989)},59760,e=>{"use strict";var t=e.i(43476),a=e.i(71645),r=e.i(18566),s=e.i(67881),i=e.i(47163);e.i(27989);var o=e.i(65658);function n(){let e=(0,r.useParams)(),n=(0,r.useRouter)(),d=e.id,[c,l]=(0,a.useState)(null),[u,m]=(0,a.useState)([]),[p,f]=(0,a.useState)(!0);async function h(){f(!0);try{let e=Number(d);if(!e){l(null),m([]),f(!1);return}let t=await (0,o.fetchPedidoDetail)(e);l(t.pedido),m(t.items)}catch(e){l(null),m([])}f(!1)}if((0,a.useEffect)(()=>{d&&h()},[d]),(0,a.useEffect)(()=>{if(c)try{let e=String(c.id).padStart(6,"0");document.title=`Ticket Pedido #${e} - Blama Shop`}catch(e){}},[c]),p)return(0,t.jsx)("div",{className:"p-10 text-center",children:"Cargando ticket..."});if(!c)return(0,t.jsx)("div",{className:"p-10 text-center",children:"Pedido no encontrado"});let b=Number(c.subtotal??c.total),w=Number(c.descuento??0),g=Number(c.total??0);return(0,t.jsxs)("div",{className:"max-w-2xl mx-auto p-6 print:p-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 mb-6 print:hidden",children:[(0,t.jsx)(s.Button,{variant:"outline",onClick:()=>n.back(),children:"Volver"}),(0,t.jsx)("div",{className:"flex gap-2",children:(0,t.jsx)(s.Button,{variant:"outline",onClick:()=>window.print(),children:"Descargar ticket"})})]}),(0,t.jsxs)("div",{className:"border border-border rounded-lg p-6 bg-card text-card-foreground print:border-0 print:rounded-none print:p-0",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-xl font-bold",children:"Ticket de Pedido"}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["#",String(c.id).padStart(6,"0")," • ",new Date(c.created_at).toLocaleString()]})]}),(0,t.jsxs)("div",{className:"text-right text-sm",children:[(0,t.jsx)("div",{className:"font-medium",children:"Estado"}),(0,t.jsx)("div",{className:"text-muted-foreground",children:c.status})]})]}),(0,t.jsxs)("div",{className:"mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"border border-border rounded-md p-4",children:[(0,t.jsx)("div",{className:"font-semibold",children:"Cliente"}),(0,t.jsx)("div",{className:"text-sm mt-1",children:c.clientes?.nombre||""}),(0,t.jsxs)("div",{className:"text-sm text-muted-foreground",children:["DNI: ",c.clientes?.dni||""]}),(0,t.jsx)("div",{className:"text-sm text-muted-foreground",children:c.clientes?.telefono||""})]}),(0,t.jsxs)("div",{className:"border border-border rounded-md p-4",children:[(0,t.jsx)("div",{className:"font-semibold",children:"Entrega"}),(0,t.jsx)("div",{className:"text-sm mt-1",children:c.clientes?.direccion||""})]})]}),(0,t.jsxs)("div",{className:"mt-6",children:[(0,t.jsx)("div",{className:"font-semibold mb-2",children:"Productos"}),(0,t.jsxs)("div",{className:"border border-border rounded-md overflow-hidden",children:[(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 p-3 bg-popover text-sm font-medium",children:[(0,t.jsx)("div",{className:"col-span-6",children:"Producto"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Cant."}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Unit."}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:"Importe"})]}),u.map(e=>{let a=Number(e.productos?.precio??0),r=Number(e.cantidad??0);return(0,t.jsxs)("div",{className:"grid grid-cols-12 gap-2 p-3 border-t border-border text-sm",children:[(0,t.jsx)("div",{className:"col-span-6",children:e.productos?.nombre||"Producto"}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:r}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:(0,i.formatCurrency)(a)}),(0,t.jsx)("div",{className:"col-span-2 text-right",children:(0,i.formatCurrency)(a*r)})]},e.id)})]})]}),(0,t.jsxs)("div",{className:"mt-6 border-t border-border pt-4 space-y-2",children:[c.cupon_codigo&&(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Cupón"}),(0,t.jsx)("span",{className:"font-medium",children:c.cupon_codigo})]}),(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Subtotal"}),(0,t.jsx)("span",{className:"font-medium",children:(0,i.formatCurrency)(b)})]}),w>0&&(0,t.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Descuento"}),(0,t.jsxs)("span",{className:"font-medium",children:["- ",(0,i.formatCurrency)(w)]})]}),(0,t.jsxs)("div",{className:"flex justify-between text-base font-bold",children:[(0,t.jsx)("span",{children:"Total"}),(0,t.jsx)("span",{children:(0,i.formatCurrency)(g)})]}),(0,t.jsxs)("div",{className:"pt-3 text-xs text-muted-foreground",children:["Pago: ",c.pago_status]})]})]})]})}e.s(["default",()=>n])}]);