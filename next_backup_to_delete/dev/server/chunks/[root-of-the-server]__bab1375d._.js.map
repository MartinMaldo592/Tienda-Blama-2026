{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Martin/Desktop/PROYECTOS/Tienda-Blama-2026/app/api/checkout/whatsapp/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { createClient } from \"@supabase/supabase-js\"\r\n\r\nexport const runtime = \"nodejs\"\r\n\r\nfunction getEnv() {\r\n  const url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n  return { url, service }\r\n}\r\n\r\nfunction normalizeDigits(v: unknown) {\r\n  return String(v ?? \"\").replace(/\\D/g, \"\")\r\n}\r\n\r\nfunction normalizeText(v: unknown) {\r\n  return String(v ?? \"\").trim()\r\n}\r\n\r\ntype CheckoutItemInput = {\r\n  id: number\r\n  quantity: number\r\n  precio?: number\r\n  nombre?: string\r\n  producto_variante_id?: number | null\r\n  variante_nombre?: string | null\r\n}\r\n\r\nexport async function GET() {\r\n  const { url, service } = getEnv()\r\n  const missing: string[] = []\r\n  if (!url) missing.push(\"SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL\")\r\n  if (!service) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\")\r\n\r\n  if (missing.length > 0) {\r\n    return NextResponse.json({ ok: false, error: \"Server env not configured\", missing }, { status: 500 })\r\n  }\r\n\r\n  return NextResponse.json({ ok: true })\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { url, service } = getEnv()\r\n    if (!url || !service) {\r\n      const missing: string[] = []\r\n      if (!url) missing.push(\"SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL\")\r\n      if (!service) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\")\r\n      return NextResponse.json({ error: \"Server env not configured\", missing }, { status: 500 })\r\n    }\r\n\r\n    const body = await req.json()\r\n\r\n    const name = normalizeText(body?.name)\r\n    const phone = normalizeDigits(body?.phone)\r\n    const dni = normalizeDigits(body?.dni).slice(0, 8)\r\n    const address = normalizeText(body?.address)\r\n    const reference = normalizeText(body?.reference)\r\n    const locationLink = normalizeText(body?.locationLink)\r\n    const shippingMethod = normalizeText(body?.shippingMethod) || null\r\n\r\n    const couponCode = normalizeText(body?.couponCode) || null\r\n    const discountRaw = Number(body?.discountAmount ?? 0)\r\n\r\n    const itemsRaw = Array.isArray(body?.items) ? (body.items as any[]) : []\r\n    const items: CheckoutItemInput[] = itemsRaw\r\n      .map((it) => ({\r\n        id: Number(it?.id ?? 0),\r\n        quantity: Number(it?.quantity ?? 0),\r\n        precio: it?.precio != null ? Number(it.precio) : undefined,\r\n        nombre: it?.nombre != null ? String(it.nombre) : undefined,\r\n        producto_variante_id: it?.producto_variante_id != null ? Number(it.producto_variante_id) : null,\r\n        variante_nombre: it?.variante_nombre != null ? String(it.variante_nombre) : null,\r\n      }))\r\n      .filter((it) => Number.isFinite(it.id) && it.id > 0 && Number.isFinite(it.quantity) && it.quantity > 0)\r\n\r\n    if (!name) return NextResponse.json({ error: \"Nombre requerido\" }, { status: 400 })\r\n    if (!phone) return NextResponse.json({ error: \"Teléfono requerido\" }, { status: 400 })\r\n    if (dni.length !== 8) return NextResponse.json({ error: \"DNI inválido\" }, { status: 400 })\r\n    if (!address) return NextResponse.json({ error: \"Dirección requerida\" }, { status: 400 })\r\n    if (items.length === 0) return NextResponse.json({ error: \"Items inválidos\" }, { status: 400 })\r\n\r\n    const subtotal = Math.max(\r\n      0,\r\n      Math.round(\r\n        items.reduce((acc, it) => {\r\n          const unit = Number(it.precio ?? 0) || 0\r\n          return acc + unit * (Number(it.quantity) || 0)\r\n        }, 0) * 100\r\n      ) / 100\r\n    )\r\n\r\n    const discountAmount = Math.max(0, Math.min(subtotal, Number.isFinite(discountRaw) ? discountRaw : 0))\r\n    const total = Math.max(0, Math.round((subtotal - discountAmount) * 100) / 100)\r\n\r\n    const direccionCompleta = `${address} ${reference ? `(Ref: ${reference})` : \"\"} ${locationLink ? `[Link: ${locationLink}]` : \"\"}`.trim()\r\n\r\n    const supabaseAdmin = createClient(url, service)\r\n\r\n    // A. Cliente\r\n    let clienteId: number | null = null\r\n    const { data: existingClients, error: existingClientsError } = await supabaseAdmin\r\n      .from(\"clientes\")\r\n      .select(\"id\")\r\n      .eq(\"telefono\", phone)\r\n      .limit(1)\r\n\r\n    if (existingClientsError) {\r\n      return NextResponse.json({ error: existingClientsError.message }, { status: 400 })\r\n    }\r\n\r\n    if (existingClients && existingClients.length > 0) {\r\n      clienteId = Number((existingClients as any)[0]?.id)\r\n      const { error: updErr } = await supabaseAdmin\r\n        .from(\"clientes\")\r\n        .update({ nombre: name, dni, direccion: direccionCompleta })\r\n        .eq(\"id\", clienteId)\r\n\r\n      if (updErr) {\r\n        return NextResponse.json({ error: updErr.message }, { status: 400 })\r\n      }\r\n    } else {\r\n      const { data: newClient, error: clientError } = await supabaseAdmin\r\n        .from(\"clientes\")\r\n        .insert({ nombre: name, telefono: phone, dni, direccion: direccionCompleta })\r\n        .select()\r\n        .single()\r\n\r\n      if (clientError) {\r\n        return NextResponse.json({ error: clientError.message }, { status: 400 })\r\n      }\r\n\r\n      clienteId = Number((newClient as any)?.id)\r\n    }\r\n\r\n    if (!clienteId) {\r\n      return NextResponse.json({ error: \"No se pudo crear cliente\" }, { status: 500 })\r\n    }\r\n\r\n    // B. Pedido\r\n    const insertPedidoFull = async () => {\r\n      return supabaseAdmin\r\n        .from(\"pedidos\")\r\n        .insert({\r\n          cliente_id: clienteId,\r\n          subtotal,\r\n          descuento: discountAmount,\r\n          cupon_codigo: couponCode,\r\n          total,\r\n          status: \"Pendiente\",\r\n          pago_status: \"Pago Contraentrega\",\r\n          metodo_envio: shippingMethod,\r\n        })\r\n        .select()\r\n        .single()\r\n    }\r\n\r\n    const insertPedidoFallback = async () => {\r\n      return supabaseAdmin\r\n        .from(\"pedidos\")\r\n        .insert({\r\n          cliente_id: clienteId,\r\n          total,\r\n          status: \"Pendiente\",\r\n          pago_status: \"Pago Contraentrega\",\r\n          metodo_envio: shippingMethod,\r\n        })\r\n        .select()\r\n        .single()\r\n    }\r\n\r\n    const { data: pedidoFull, error: pedidoFullErr } = await insertPedidoFull()\r\n\r\n    let pedido = pedidoFull as any\r\n\r\n    if (pedidoFullErr) {\r\n      if ((couponCode && couponCode.length > 0) || discountAmount > 0) {\r\n        return NextResponse.json({ error: pedidoFullErr.message }, { status: 400 })\r\n      }\r\n\r\n      const { data: pedidoFallback, error: pedidoFallbackErr } = await insertPedidoFallback()\r\n      if (pedidoFallbackErr) {\r\n        return NextResponse.json({ error: pedidoFallbackErr.message }, { status: 400 })\r\n      }\r\n      pedido = pedidoFallback as any\r\n    }\r\n\r\n    const pedidoId = Number(pedido?.id ?? 0)\r\n    if (!pedidoId) {\r\n      return NextResponse.json({ error: \"No se pudo crear pedido\" }, { status: 500 })\r\n    }\r\n\r\n    // C. Items\r\n    const orderItems = items.map((item) => ({\r\n      pedido_id: pedidoId,\r\n      producto_id: item.id,\r\n      producto_variante_id: item.producto_variante_id ?? null,\r\n      precio_unitario: Number(item.precio ?? 0) || 0,\r\n      producto_nombre: item.nombre ? String(item.nombre) : null,\r\n      variante_nombre: item.variante_nombre ? String(item.variante_nombre) : null,\r\n      cantidad: Number(item.quantity) || 1,\r\n    }))\r\n\r\n    const { error: itemsError } = await supabaseAdmin.from(\"pedido_items\").insert(orderItems)\r\n    if (itemsError) {\r\n      return NextResponse.json({ error: itemsError.message }, { status: 400 })\r\n    }\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      orderId: pedidoId,\r\n      subtotal,\r\n      descuento: discountAmount,\r\n      total,\r\n    })\r\n  } catch (e: any) {\r\n    return NextResponse.json({ error: e?.message || \"Unknown error\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}