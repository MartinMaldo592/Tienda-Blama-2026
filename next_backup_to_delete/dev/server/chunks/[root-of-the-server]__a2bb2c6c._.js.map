{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Martin/Desktop/PROYECTOS/Tienda-Blama-2026/app/api/notify-admin/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport twilio from 'twilio'\r\n\r\nconst currencyFormatter = new Intl.NumberFormat('es-PE', {\r\n    style: 'currency',\r\n    currency: 'PEN',\r\n    minimumFractionDigits: 2,\r\n    maximumFractionDigits: 2,\r\n})\r\n\r\n// Twilio credentials from environment variables\r\nconst accountSid = process.env.TWILIO_ACCOUNT_SID\r\nconst authToken = process.env.TWILIO_AUTH_TOKEN\r\nconst twilioWhatsAppNumber = process.env.TWILIO_WHATSAPP_NUMBER // Format: whatsapp:+14155238886\r\nconst adminWhatsAppNumber = process.env.ADMIN_WHATSAPP_NUMBER // Format: whatsapp:+51982432561\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        // Validate environment variables\r\n        if (!accountSid || !authToken || !twilioWhatsAppNumber || !adminWhatsAppNumber) {\r\n            console.error('Missing Twilio environment variables')\r\n            return NextResponse.json(\r\n                { error: 'Server configuration error' },\r\n                { status: 500 }\r\n            )\r\n        }\r\n\r\n        // Get order data from request body\r\n        const body = await request.json()\r\n        const { orderId, clientName, clientDni, clientPhone, address, items, total, panelLink } = body\r\n\r\n        // Create the notification message\r\n        let message = `ðŸ”” *NUEVO PEDIDO #${orderId}* ðŸ””\\n\\n`\r\n        message += `â° ${new Date().toLocaleString('es-PE')}\\n\\n`\r\n        message += `ðŸ‘¤ *Cliente:* ${clientName}\\n`\r\n        if (clientDni) {\r\n            message += `ðŸªª *DNI:* ${clientDni}\\n`\r\n        }\r\n        message += `ðŸ“± *Tel:* ${clientPhone}\\n`\r\n        message += `ðŸ“ *DirecciÃ³n:* ${address}\\n\\n`\r\n        message += `*PRODUCTOS:*\\n`\r\n\r\n        items.forEach((item: any) => {\r\n            message += `â€¢ ${item.quantity}x ${item.nombre} (${currencyFormatter.format(Number(item.precio || 0) * Number(item.quantity || 0))})\\n`\r\n        })\r\n\r\n        message += `\\nðŸ’° *TOTAL: ${currencyFormatter.format(Number(total || 0))}*\\n`\r\n        message += `\\nðŸ”— Ver pedido: ${panelLink}`\r\n\r\n        // Initialize Twilio client\r\n        // Validate account SID prefix (Twilio account SIDs start with \"AC\")\r\n        if (!accountSid.startsWith('AC')) {\r\n            console.error('Invalid TWILIO_ACCOUNT_SID: must start with \"AC\"')\r\n            return NextResponse.json(\r\n                { error: 'Server configuration error: invalid TWILIO_ACCOUNT_SID' },\r\n                { status: 500 }\r\n            )\r\n        }\r\n\r\n        // Validate WhatsApp number formats: should start with \"whatsapp:+\"\r\n        const invalidWhatsAppFormat = (n?: string) => !n || !n.startsWith('whatsapp:+')\r\n        if (invalidWhatsAppFormat(twilioWhatsAppNumber) || invalidWhatsAppFormat(adminWhatsAppNumber)) {\r\n            console.error('Invalid WhatsApp number format for TWILIO_WHATSAPP_NUMBER or ADMIN_WHATSAPP_NUMBER')\r\n            return NextResponse.json(\r\n                { error: 'Server configuration error: WhatsApp numbers must use format \"whatsapp:+{country}{number}\"' },\r\n                { status: 500 }\r\n            )\r\n        }\r\n\r\n        const client = twilio(accountSid, authToken)\r\n\r\n        // Send WhatsApp message to admin\r\n        const twilioMessage = await client.messages.create({\r\n            body: message,\r\n            from: twilioWhatsAppNumber,\r\n            to: adminWhatsAppNumber\r\n        })\r\n\r\n        console.log('WhatsApp notification sent:', {\r\n            sid: twilioMessage.sid,\r\n            status: twilioMessage.status,\r\n            to: twilioMessage.to,\r\n            from: twilioMessage.from,\r\n            errorCode: (twilioMessage as any).errorCode ?? null,\r\n            errorMessage: (twilioMessage as any).errorMessage ?? null,\r\n        })\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            messageId: twilioMessage.sid,\r\n            status: twilioMessage.status,\r\n            errorCode: (twilioMessage as any).errorCode ?? null,\r\n            errorMessage: (twilioMessage as any).errorMessage ?? null,\r\n            to: twilioMessage.to,\r\n            from: twilioMessage.from\r\n        })\r\n\r\n    } catch (error: any) {\r\n        console.error('Error sending WhatsApp notification:', error)\r\n        return NextResponse.json(\r\n            { error: error.message || 'Failed to send notification' },\r\n            { status: 500 }\r\n        )\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}