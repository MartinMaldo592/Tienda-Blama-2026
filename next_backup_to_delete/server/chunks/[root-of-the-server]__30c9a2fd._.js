module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},10517,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),a=e.i(59756),o=e.i(61916),s=e.i(74677),i=e.i(69741),u=e.i(16795),l=e.i(87718),d=e.i(95169),p=e.i(47587),c=e.i(66012),m=e.i(70101),h=e.i(26937),x=e.i(10372),R=e.i(93695);e.i(52474);var g=e.i(5232),f=e.i(89171),v=e.i(24389);function N(){return{url:process.env.SUPABASE_URL||"https://pvgghvcqoxhcozlyagwz.supabase.co",service:process.env.SUPABASE_SERVICE_ROLE_KEY}}function b(e){return String(e??"").replace(/\D/g,"")}function E(e){return String(e??"").trim()}async function _(){let{url:e,service:t}=N(),r=[];return(t||r.push("SUPABASE_SERVICE_ROLE_KEY"),r.length>0)?f.NextResponse.json({ok:!1,error:"Server env not configured",missing:r},{status:500}):f.NextResponse.json({ok:!0})}async function w(e){try{let{url:t,service:r}=N();if(!t||!r){let e=[];return r||e.push("SUPABASE_SERVICE_ROLE_KEY"),f.NextResponse.json({error:"Server env not configured",missing:e},{status:500})}let n=await e.json(),a=E(n?.name),o=b(n?.phone),s=b(n?.dni).slice(0,8),i=E(n?.address),u=E(n?.reference),l=E(n?.locationLink),d=E(n?.shippingMethod)||null,p=E(n?.couponCode)||null,c=Number(n?.discountAmount??0),m=(Array.isArray(n?.items)?n.items:[]).map(e=>({id:Number(e?.id??0),quantity:Number(e?.quantity??0),precio:e?.precio!=null?Number(e.precio):void 0,nombre:e?.nombre!=null?String(e.nombre):void 0,producto_variante_id:e?.producto_variante_id!=null?Number(e.producto_variante_id):null,variante_nombre:e?.variante_nombre!=null?String(e.variante_nombre):null})).filter(e=>Number.isFinite(e.id)&&e.id>0&&Number.isFinite(e.quantity)&&e.quantity>0);if(!a)return f.NextResponse.json({error:"Nombre requerido"},{status:400});if(!o)return f.NextResponse.json({error:"Teléfono requerido"},{status:400});if(8!==s.length)return f.NextResponse.json({error:"DNI inválido"},{status:400});if(!i)return f.NextResponse.json({error:"Dirección requerida"},{status:400});if(0===m.length)return f.NextResponse.json({error:"Items inválidos"},{status:400});let h=Math.max(0,Math.round(100*m.reduce((e,t)=>{let r=Number(t.precio??0)||0;return e+r*(Number(t.quantity)||0)},0))/100),x=Math.max(0,Math.min(h,Number.isFinite(c)?c:0)),R=Math.max(0,Math.round((h-x)*100)/100),g=`${i} ${u?`(Ref: ${u})`:""} ${l?`[Link: ${l}]`:""}`.trim(),_=(0,v.createClient)(t,r),w=null,{data:y,error:C}=await _.from("clientes").select("id").eq("telefono",o).limit(1);if(C)return f.NextResponse.json({error:C.message},{status:400});if(y&&y.length>0){w=Number(y[0]?.id);let{error:e}=await _.from("clientes").update({nombre:a,dni:s,direccion:g}).eq("id",w);if(e)return f.NextResponse.json({error:e.message},{status:400})}else{let{data:e,error:t}=await _.from("clientes").insert({nombre:a,telefono:o,dni:s,direccion:g}).select().single();if(t)return f.NextResponse.json({error:t.message},{status:400});w=Number(e?.id)}if(!w)return f.NextResponse.json({error:"No se pudo crear cliente"},{status:500});let A=async()=>_.from("pedidos").insert({cliente_id:w,subtotal:h,descuento:x,cupon_codigo:p,total:R,status:"Pendiente",pago_status:"Pago Contraentrega",metodo_envio:d}).select().single(),S=async()=>_.from("pedidos").insert({cliente_id:w,total:R,status:"Pendiente",pago_status:"Pago Contraentrega",metodo_envio:d}).select().single(),{data:j,error:q}=await A(),P=j;if(q){if(p&&p.length>0||x>0)return f.NextResponse.json({error:q.message},{status:400});let{data:e,error:t}=await S();if(t)return f.NextResponse.json({error:t.message},{status:400});P=e}let k=Number(P?.id??0);if(!k)return f.NextResponse.json({error:"No se pudo crear pedido"},{status:500});let T=m.map(e=>({pedido_id:k,producto_id:e.id,producto_variante_id:e.producto_variante_id??null,precio_unitario:Number(e.precio??0)||0,producto_nombre:e.nombre?String(e.nombre):null,variante_nombre:e.variante_nombre?String(e.variante_nombre):null,cantidad:Number(e.quantity)||1})),{error:O}=await _.from("pedido_items").insert(T);if(O)return f.NextResponse.json({error:O.message},{status:400});return f.NextResponse.json({ok:!0,orderId:k,subtotal:h,descuento:x,total:R})}catch(e){return f.NextResponse.json({error:e?.message||"Unknown error"},{status:500})}}e.s(["GET",()=>_,"POST",()=>w,"runtime",0,"nodejs"],90895);var y=e.i(90895);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/checkout/whatsapp/route",pathname:"/api/checkout/whatsapp",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/checkout/whatsapp/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:A,workUnitAsyncStorage:S,serverHooks:j}=C;function q(){return(0,n.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:S})}async function P(e,t,n){C.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/checkout/whatsapp/route";f=f.replace(/\/index$/,"")||"/";let v=await C.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:N,params:b,nextConfig:E,parsedUrl:_,isDraftMode:w,prerenderManifest:y,routerServerContext:A,isOnDemandRevalidate:S,revalidateOnlyGenerated:j,resolvedPathname:q,clientReferenceManifest:P,serverActionsManifest:k}=v,T=(0,i.normalizeAppPath)(f),O=!!(y.dynamicRoutes[T]||y.routes[q]),U=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,_,!1):t.end("This page could not be found"),null);if(O&&!w){let e=!!y.routes[q],t=y.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await U();throw new R.NoFallbackError}}let I=null;!O||C.isDev||w||(I="/index"===(I=q)?"/":I);let M=!0===C.isDev||!O,H=O&&!M;k&&P&&(0,s.setManifestsSingleton)({page:f,clientReferenceManifest:P,serverActionsManifest:k});let D=e.method||"GET",$=(0,o.getTracer)(),F=$.getActiveScopeSpan(),K={params:b,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>C.onRequestError(e,t,n,a,A)},sharedContext:{buildId:N}},L=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),V=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let s=async e=>C.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${D} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${f}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var o,u;let l=async({previousCacheEntry:r})=>{try{if(!i&&S&&j&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let u=K.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let l=K.renderOpts.collectedTags;if(!O)return await (0,c.sendResponse)(L,B,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[x.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=x.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=x.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})},!1,A),t}},d=await C.handleResponse({req:e,nextConfig:E,cacheKey:I,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:j,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:i});if(!O)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let R=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&O||R.delete(x.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||R.get("Cache-Control")||R.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,c.sendResponse)(L,B,new Response(d.value.body,{headers:R,status:d.value.status||200})),null};F?await u(F):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${D} ${f}`,kind:o.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})},!1,A),O)throw t;return await (0,c.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>q,"routeModule",()=>C,"serverHooks",()=>j,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>S],10517)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__30c9a2fd._.js.map