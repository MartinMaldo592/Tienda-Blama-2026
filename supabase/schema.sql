
-- Enable necessary extensions if needed
-- create extension if not exists "uuid-ossp";

-- Categorias
create table if not exists categorias (
  id bigint generated by default as identity primary key,
  nombre text not null,
  slug text not null unique,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Productos
create table if not exists productos (
  id bigint generated by default as identity primary key,
  nombre text not null,
  precio numeric not null,
  precio_antes numeric,
  descripcion text,
  materiales text,
  tamano text,
  color text,
  cuidados text,
  uso text,
  stock integer not null default 0,
  imagen_url text,
  imagenes text[],
  categoria_id bigint references categorias(id) on delete set null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table productos add column if not exists precio_antes numeric;

alter table productos add column if not exists descripcion text;
alter table productos add column if not exists materiales text;
alter table productos add column if not exists tamano text;
alter table productos add column if not exists color text;
alter table productos add column if not exists cuidados text;
alter table productos add column if not exists uso text;

-- Variantes
create table if not exists producto_variantes (
  id bigint generated by default as identity primary key,
  producto_id bigint not null references productos(id) on delete cascade,
  etiqueta text not null,
  talla text,
  color text,
  modelo text,
  precio numeric,
  precio_antes numeric,
  stock integer not null default 0,
  activo boolean not null default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create index if not exists producto_variantes_producto_id_idx on public.producto_variantes (producto_id);

-- Especificaciones (ficha t√©cnica)
create table if not exists producto_especificaciones (
  id bigint generated by default as identity primary key,
  producto_id bigint not null references productos(id) on delete cascade,
  clave text not null,
  valor text,
  orden integer not null default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create index if not exists producto_especificaciones_producto_id_idx on public.producto_especificaciones (producto_id);

-- Clientes
create table if not exists clientes (
  id bigint generated by default as identity primary key,
  nombre text not null,
  telefono text,
  dni text,
  direccion text,
  es_problematico boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table clientes add column if not exists dni text;

-- Pedidos
create table if not exists pedidos (
  id bigint generated by default as identity primary key,
  cliente_id bigint references clientes(id) on delete set null,
  total numeric not null,
  stock_descontado boolean not null default false,
  status text check (status in ('Pendiente', 'Confirmado', 'Preparando', 'Enviado', 'Entregado', 'Fallido', 'Devuelto')) default 'Pendiente',
  pago_status text check (pago_status in ('Pendiente', 'Pagado Anticipado', 'Pago Contraentrega', 'Pagado al Recibir')) default 'Pendiente',
  voucher_url text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Pedido Items
create table if not exists pedido_items (
  id bigint generated by default as identity primary key,
  pedido_id bigint references pedidos(id) on delete cascade,
  producto_id bigint references productos(id) on delete set null,
  producto_variante_id bigint references producto_variantes(id) on delete set null,
  precio_unitario numeric,
  producto_nombre text,
  variante_nombre text,
  cantidad integer not null
);

-- Incidencias
create table if not exists incidencias (
  id bigint generated by default as identity primary key,
  pedido_id bigint references pedidos(id) on delete cascade,
  tipo text,
  comentario text,
  foto text,
  fotos text[],
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

create table if not exists cupones (
  id bigint generated by default as identity primary key,
  codigo text not null unique,
  tipo text not null default 'porcentaje' check (tipo in ('porcentaje', 'monto')),
  valor numeric not null,
  activo boolean not null default true,
  min_total numeric not null default 0,
  max_usos integer,
  usos integer not null default 0,
  starts_at timestamp with time zone,
  expires_at timestamp with time zone,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table pedidos add column if not exists subtotal numeric;
alter table pedidos add column if not exists descuento numeric default 0;
alter table pedidos add column if not exists cupon_codigo text;
alter table pedidos add column if not exists stock_descontado boolean not null default false;

alter table incidencias add column if not exists fotos text[];

create table if not exists home_banners (
  id bigint generated by default as identity primary key,
  title text,
  subtitle text,
  cta text,
  href text not null,
  orden integer not null default 0,
  activo boolean not null default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table home_banners enable row level security;

drop policy if exists home_banners_read on public.home_banners;
drop policy if exists home_banners_insert on public.home_banners;
drop policy if exists home_banners_update on public.home_banners;
drop policy if exists home_banners_delete on public.home_banners;

create policy home_banners_read
on public.home_banners
for select
using (true);

create policy home_banners_insert
on public.home_banners
for insert
to authenticated
with check (
  exists (
    select 1
    from public.profiles p
    where p.id = auth.uid()
      and p.role = 'admin'
  )
);

create policy home_banners_update
on public.home_banners
for update
to authenticated
using (
  exists (
    select 1
    from public.profiles p
    where p.id = auth.uid()
      and p.role = 'admin'
  )
)
with check (
  exists (
    select 1
    from public.profiles p
    where p.id = auth.uid()
      and p.role = 'admin'
  )
);

create policy home_banners_delete
on public.home_banners
for delete
to authenticated
using (
  exists (
    select 1
    from public.profiles p
    where p.id = auth.uid()
      and p.role = 'admin'
  )
);
